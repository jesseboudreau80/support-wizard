generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Org {
  id          String   @id @default(uuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  tickets     Ticket[]
  roles       RoleAssignment[]
  documents   KnowledgeBaseDocument[]
}

model User {
  id          String   @id @default(uuid())
  org         Org      @relation(fields: [orgId], references: [id])
  orgId       String
  email       String   @unique
  displayName String
  provider    AuthProvider
  providerId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tickets     Ticket[] @relation("TicketCreator")
  messages    Message[]
  roles       RoleAssignment[]
  routingReviews RoutingFeedback[]
}

enum AuthProvider {
  GOOGLE
  MICROSOFT
  GITHUB
  OKTA
}

enum Role {
  SUPERADMIN
  ADMIN
  AGENT
  USER
}

model RoleAssignment {
  id        String   @id @default(uuid())
  org       Org      @relation(fields: [orgId], references: [id])
  orgId     String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  role      Role
  createdAt DateTime @default(now())
}

enum InputType {
  VOICE
  TEXT
}

enum TicketStatus {
  OPEN
  PENDING
  CLOSED
}

model Ticket {
  id               String   @id @default(uuid())
  org              Org      @relation(fields: [orgId], references: [id])
  orgId            String
  creator          User     @relation("TicketCreator", fields: [userId], references: [id])
  userId           String
  inputType        InputType
  rawInput         String
  aiSummary        String
  proposedDepartment String
  confidenceScore  Float
  status           TicketStatus @default(OPEN)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  messages         Message[]
  routingFeedback  RoutingFeedback[]
}

model Message {
  id        String   @id @default(uuid())
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
  ticketId  String
  author    User?    @relation(fields: [userId], references: [id])
  userId    String?
  content   String
  createdAt DateTime @default(now())
}

model RoutingFeedback {
  id          String   @id @default(uuid())
  ticket      Ticket   @relation(fields: [ticketId], references: [id])
  ticketId    String
  reviewer    User?    @relation(fields: [reviewerId], references: [id])
  reviewerId  String?
  isCorrect   Boolean
  correctedDepartment String?
  notes       String?
  createdAt   DateTime @default(now())
}

model KnowledgeBaseDocument {
  id          String   @id @default(uuid())
  org         Org      @relation(fields: [orgId], references: [id])
  orgId       String
  title       String
  content     String
  metadata    Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
